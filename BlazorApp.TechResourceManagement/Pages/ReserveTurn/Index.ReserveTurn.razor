@using BlazorApp.TechResourceManagement.Bussiness
@using BlazorApp.TechResourceManagement.Domain
@using BlazorApp.TechResourceManagement.Models
@using BlazorApp.TechResourceManagement.Pages.Home.Components
@using System.ComponentModel.DataAnnotations
@using BlazorApp.TechResourceManagement.Pages.ReserveTurn.Components

@attribute [Authorize]

@inject DialogService DialogService
@inject GestorRTRT _gestorRTRT
@inject IJSRuntime JsRuntime

@page "/reserveTurn"

<div class="container-fluid">
    <div class="px-3 py-4">
        @if (cmbTiposRecursosTecnologicos == null)
        {
            <Loading />
        }
        else
        {
            <h3>Reservar turno de recurso tecnológico</h3>
            <div class="row g-3">
                <div class="col-12">
                    <div class="form-group">
                        <label for="Dni">Tipo de Recurso Tecnologico: </label>
                        <RadzenDropDown AllowClear="true" TValue="string"
                                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    AllowFiltering="true" Class="w-100"
                                    Placeholder="Todas"
                                    Data=@cmbTiposRecursosTecnologicos
                                    TextProperty="MostrarCategoria"
                                    ValueProperty="MostrarCategoria"
                                    Change=@(args => TomarSeleccionTipoRecurso(args)) />
                    </div>
                </div>
                @if (gridCIsConRecursosTecnologicos != null)
                {
                    <div class="accordion" id="acordionCIs">
                        @foreach (var ci in gridCIsConRecursosTecnologicos)
                        {
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="panel-heading-@ci.CI.Sigla">
                                    <button class="accordion-button @(gridCIsConRecursosTecnologicos.IndexOf(ci) != 0 ? "collapsed" : "")" type="button"
                                data-bs-toggle="collapse"
                                aria-expanded="false"
                                data-bs-target="#panel-@ci.CI.Sigla">
                                        @ci.CI.Nombre
                                    </button>
                                </h2>
                                <div id="panel-@ci.CI.Sigla" class="accordion-collapse  @(gridCIsConRecursosTecnologicos.IndexOf(ci) != 0 ? "collapse" : "collapse show")" aria-labelledby="panel-heading-@ci.CI.Sigla" data-bs-parent="#acordionCIs">
                                    <div class="accordion-body">
                                        <table class="table table-striped table-responsive-xl">
                                            <thead>
                                                <tr>
                                                    <th>Nro Recurso Tecnologico</th>
                                                    <th>Marca</th>
                                                    <th>Modelo</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var rt in ci.RecursosTecnologicos)
                                                {
                                                    <tr>
                                                        <td>@rt.Recurso.NumeroRT</td>
                                                        <td>@rt.Recurso.ModeloDelRT.Nombre</td>
                                                        <td>@rt.MarcaDelRt.Nombre</td>
                                                        @switch (rt.Recurso.GetEstadoActual())
                                                        {
                                                            case "Disponible":
                                                                <td><h3 class="badge bg-primary">@rt.Recurso.GetEstadoActual()</h3></td>
                                                                break;
                                                            case "EnMantenimiento":
                                                                <td><h3 class="badge bg-success">@rt.Recurso.GetEstadoActual()</h3></td>
                                                                break;
                                                            case "ConIngresoEnMantenimientoCorrectivo":
                                                                <td><h3 class="badge bg-secondary">@rt.Recurso.GetEstadoActual()</h3></td>
                                                                break;
                                                        }
                                                        <td>
                                                            <div class=" btn-group">
                                                                @if (estaSeleccionado && rt.Recurso.NumeroRT == txtRTSeleccionado)
                                                                {
                                                                    <button type="button" class="btn btn-primary btn-sm" @onclick="(args)=> SolicitarDeseleccionRecursoTecnologico(rt.Recurso.NumeroRT, ci.CI.Sigla)">
                                                                        <i class="fa-solid fa-square-check"></i>
                                                                    </button>
                                                                }
                                                                else
                                                                {
                                                                    <button type="button" class="btn btn-danger btn-sm" @onclick="(args)=> SolicitarSeleccionRecursoTecnologico(rt.Recurso.NumeroRT, ci.CI.Sigla)">
                                                                        <i class="fa-solid fa-square-minus"></i>
                                                                    </button>
                                                                }
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                                @if (ci.RecursosTecnologicos.Count == 0)
                                                {
                                                    <tr class="text-center">
                                                        <td colspan="5">
                                                            <span class="badge bg-secondary">Table no contain elements. Table is empty</span>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

@if (gridTurnos != null)
{
    <div class="container-fluid">
        <div class="px-3 py-4">
            <RadzenScheduler @ref=@scheduler SlotRender=@OnSlotRender style="height: 768px;" TItem="Turno" Data=@gridTurnos StartProperty="FechaHoraInicio" EndProperty="FechaHoraFin"
                         SelectedIndex="1" TextProperty="TextDisplay"
                         SlotSelect=@OnSlotSelect AppointmentSelect=@OnAppointmentSelect AppointmentRender=@OnAppointmentRender>
                <RadzenWeekView />
                <RadzenMonthView />
            </RadzenScheduler>
        </div>
    </div>
}

@code {
    private string cmbTpSeleccionado { get; set; }
    private long txtRTSeleccionado { get; set; }
    private string txtCISeleccionado { get; set; }
    private bool estaSeleccionado { get; set; } = false;
    private RadzenScheduler<Turno> scheduler;
    private IList<TipoRecursoTecnologico> cmbTiposRecursosTecnologicos { get; set; }
    private IList<dynamic> gridCIsConRecursosTecnologicos { get; set; }
    private IList<Turno> gridTurnos { get; set; }

    //Metodo Inicilizador de la Pantalla
    protected override async Task OnInitializedAsync()
    {
        //Dependencia al GestorRTRT se inyecta arriba @inject
        await SolicitarSeleccionTiposRecursosTecnologicos();
    }

    //Muestra los tipos de recursos tecnologicos
    private async Task SolicitarSeleccionTiposRecursosTecnologicos()
    {
        cmbTiposRecursosTecnologicos = await _gestorRTRT.ReservarTurnoRecursoTecnologico();
        this.gridCIsConRecursosTecnologicos = await _gestorRTRT.TomarTipoRecurso(this.cmbTpSeleccionado);
    }

    //On Change Seleccion Tipo Recurso Tecnologico
    private async Task TomarSeleccionTipoRecurso(object value)
    {
        var cmbTpSeleccionado = value is IEnumerable<object> ? string.Join(", ", (IEnumerable<object>)value) : value;
        this.cmbTpSeleccionado = cmbTpSeleccionado.ToString();
        this.gridCIsConRecursosTecnologicos = await _gestorRTRT.TomarTipoRecurso(this.cmbTpSeleccionado);
    }

    //On Change Seleccion Recurso Tecnologico
    private async Task SolicitarSeleccionRecursoTecnologico(long txtRTSeleccionado, string txtCISeleccionado)
    {
        this.TomarSeleccionRecursoTecnologico(txtRTSeleccionado, txtCISeleccionado);

        //Obtener los turnos
        gridTurnos = await _gestorRTRT.TomarRecursoTecnologico(this.txtRTSeleccionado, this.txtCISeleccionado);
        if (gridTurnos == null)
        {
            //this.ClearRecursoSeleccionado();
            this.ShowBusyDialog(true, "El recurso tecnologico seleccionado no posee turnos.");
            this.ClearRecursoSeleccionado();
            //await JsRuntime.InvokeAsync<string>("alert", "El recurso tecnologico no posee turnos");
        }
    }

    //On Change Seleccion Recurso Tecnologico
    private async Task SolicitarDeseleccionRecursoTecnologico(long txtRTSeleccionado, string txtCISeleccionado)
    {
        if (txtRTSeleccionado == this.txtRTSeleccionado)
        {
            this.ClearRecursoSeleccionado();
            this.gridTurnos = null;
        }
    }

    private void TomarSeleccionRecursoTecnologico(long txtRTSeleccionado, string txtCISeleccionado)
    {
        this.estaSeleccionado = txtRTSeleccionado != this.txtRTSeleccionado ? true : !this.estaSeleccionado;
        this.txtRTSeleccionado = txtRTSeleccionado;
        this.txtCISeleccionado = txtCISeleccionado;
    }

    private void ClearRecursoSeleccionado()
    {
        this.estaSeleccionado = !this.estaSeleccionado;
        this.txtCISeleccionado = string.Empty;
        this.txtRTSeleccionado = 0;
    }

    public void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        // Highlight today in month view
        bool poseeTurno = gridTurnos.Any(turno => turno.FechaHoraInicio.Date == args.Start.Date && turno.EstoyDisponible());
        if (args.View.Text == "Month" && poseeTurno)
        {
            args.Attributes["class"] = "bg-primary bg-gradient";
        }
        else
        {
            args.Attributes["class"] = "bg-danger bg-gradient";
        }

        // Highlight working hours (9-18)
        if ((args.View.Text == "Week" || args.View.Text == "Day") )
        {
            if (args.Start.Hour > 8 && args.Start.Hour < 19 && poseeTurno)
            {
                args.Attributes["class"] = "bg-primary bg-gradient";
            }
            else if (args.Start.Hour > 8 && args.Start.Hour < 19 && !poseeTurno)
            {
                args.Attributes["class"] = "bg-danger bg-gradient";
            }
            else
            {
                args.Attributes["class"] = "bg-secondary bg-gradient";
            }
        }
    }

    public async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        Turno data = await DialogService.OpenAsync<AddAppointmentPage>("Add Appointment",
            new Dictionary<string, object> { { "Start", args.Start }, { "End", args.End } });

        if (data != null)
        {
            gridTurnos.Add(data);
            // Either call the Reload method or reassign the Data property of the Scheduler
            await scheduler.Reload();
        }
    }

    public async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<Turno> args)
    {
        await scheduler.Reload();
    }

    public void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<Turno> args)
    {
        // Never call StateHasChanged in AppointmentRender - would lead to infinite loop
        args.Attributes["title"] = $"{args.Data.FechaHoraInicio.ToLongDateString()}-{args.Data.FechaHoraFin.ToLongDateString()}";

        switch (args.Data.MostrarTurno().MostrarEstadoActual())
        {
            case "Disponible":
                args.Attributes["class"] = "mb-2 bg-primary bg-gradient border rounded text-white";
                break;
            case "PendienteConfirmacion":
                args.Attributes["class"] = "mb-2 bg-secondary bg-gradient border rounded text-white";
                break;
            case "Reservado":
                args.Attributes["class"] = "mb-2 bg-danger bg-gradient rounded border text-white";
                break;
        }
    }

    public async Task ShowBusyDialog(bool withMessageAsString, string message)
    {
        InvokeAsync(async () =>
        {
            // Simulate background task
            await Task.Delay(2000);

            // Close the dialog
            DialogService.Close();
        });

        if (withMessageAsString)
        {
            await BusyDialog(message);
        }
        else
        {
            await BusyDialog(string.Empty);
        }
    }

    // Busy dialog from markup
    public async Task BusyDialog(string message)
    {
        await DialogService.OpenAsync("Información", ds =>
                @<div>
                    <div class="row">
                        <div class="col text-center p-5">
                            <RadzenImage Path="images/resource-tech-background-1.jpg"
                                     class=" d-inline-block justify-content-between align-items-center"
                                     Style="width: 200px; margin-bottom: 40px;" />
                            <h3>@message</h3>
                        </div>
                    </div>
                </div>,
                new DialogOptions()
                {
                    Style = "min-height:auto;min-width:auto;width:auto",
                    CloseDialogOnEsc = true,
                    CloseDialogOnOverlayClick = true
                });
    }
}
